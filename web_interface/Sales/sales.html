<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo de Ventas - S&M</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header" style="padding: 0.75rem 1rem; min-height: auto;">
            <div class="header-content" style="padding: 0;">
                <div class="logo-section" style="align-items: center; gap: 1rem;">
                    <div class="logo-circle" style="width: 50px; height: 50px; font-size: 0.85rem;">
                        <span class="logo-text" style="font-size: 0.9rem; font-weight: bold;">S&M</span>
                        <div class="logo-subtitle" style="font-size: 0.6rem; margin-top: 2px;">VENTAS</div>
                    </div>
                    <div class="title-section">
                        <h1 class="main-title" style="font-size: 1.25rem; margin: 0; line-height: 1.2;">Módulo de Ventas</h1>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="sales-container">
                
                <!-- Información de Venta y Agregar Producto -->
                <div class="sales-section">
                  
                    <!-- Información de Venta -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label" for="folio">Folio de Venta:</label>
                            <input type="text" id="folio" class="form-input" readonly placeholder="Se generará automáticamente">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="cliente">Nombre del Cliente:</label>
                            <input type="text" id="cliente" class="form-input" placeholder="Consumidor Final" >
                        </div>
                    </div>
                    
                    <!-- Separador visual -->
                    <div style="border-top: 1px solid #e0e0e0; margin: 1rem 0; padding-top: 1rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-color); font-size: 1rem;">
                            <i class="fas fa-plus-circle" style="margin-right: 0.5rem; color: var(--primary-color);"></i>
                            Agregar Producto
                        </h4>
                    </div>
                    
                    <!-- Agregar Producto -->
                    <div style="display: grid; grid-template-columns: 1fr 200px; gap: 1rem; align-items: end; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label" for="descripcion">Descripción del Producto:</label>
                            <input type="text" id="descripcion" class="form-input" placeholder="Ingrese la descripción">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="precio">Precio ($):</label>
                            <input type="text" id="precio" class="form-input" placeholder="0.00" inputmode="decimal" pattern="[0-9]+(\.[0-9]{1,2})?">
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn-sales btn-success" onclick="agregarProducto()">
                            <i class="fas fa-plus"></i> Agregar
                        </button>
                        <button class="btn-sales btn-danger" onclick="cancelarOperacion()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button class="btn-sales" onclick="testPyWebView()" style="background: #17a2b8;">
                            <i class="fas fa-bug"></i> Test API
                        </button>
                        <button class="btn-sales" onclick="testSimple()" style="background: #6c757d;">
                            <i class="fas fa-flask"></i> Test Simple
                        </button>
                        <button class="btn-sales" onclick="testDirectPython()" style="background: #dc3545;">
                            <i class="fas fa-fire"></i> Test Python
                        </button>
                    </div>
                </div>

                <!-- Lista de Productos -->
                <div class="sales-section">
                    <div class="section-title">
                        <i class="fas fa-list-ul"></i>
                        Productos Agregados
                        <span id="contador-productos" style="margin-left: auto; background: var(--secondary-color); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.9rem;">0</span>
                    </div>
                    
                    <div id="productos-container">
                        <div class="empty-state">
                            <i class="fas fa-shopping-basket"></i>
                            <p>No hay productos en la venta actual</p>
                            <p>Agregue productos usando el formulario anterior</p>
                        </div>
                    </div>
                    
                    <table id="productos-tabla" class="products-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Descripción</th>
                                <th>Precio</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productos-tbody">
                        </tbody>
                    </table>
                    
                    <div id="productos-acciones" class="action-buttons" style="display: none;">
                        <button class="btn-sales btn-warning" onclick="limpiarTodo()">
                            <i class="fas fa-broom"></i> Limpiar Todo
                        </button>
                    </div>
                </div>

                <!-- Total y Finalización -->
                <div class="sales-section" id="finalizacion-section" style="display: none;">
                    <div class="total-section">
                        <div>Total de la Venta</div>
                        <div class="total-amount" id="total-venta">$0.00</div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn-sales btn-success" onclick="finalizarVenta()" style="font-size: 1.1rem; padding: 1rem 2rem;">
                            <i class="fas fa-check-circle"></i> Finalizar Venta
                        </button>
                    </div>
                </div>

                <!-- Opciones Post-Venta -->
                <div class="sales-section" id="post-venta-section" style="display: none;">
                    <div class="section-title">
                        <i class="fas fa-cog"></i>
                        Opciones de Venta
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn-sales" onclick="imprimirVenta()">
                            <i class="fas fa-print"></i> Imprimir
                        </button>
                        <button class="btn-sales" onclick="abrirModalCorreo()">
                            <i class="fas fa-envelope"></i> Enviar por Correo
                        </button>
                        <button class="btn-sales btn-success" onclick="nuevaVenta()">
                            <i class="fas fa-plus"></i> Nueva Venta
                        </button>
                    </div>
                </div>

            </div>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <p>&copy; 2025 Sistema de Ventas S&M - Módulo de Ventas Web</p>
        </footer>
    </div>

    <!-- Modal para envío de correo -->
    <div id="emailModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <i class="fas fa-envelope"></i>
                <span>Enviar Venta por Correo Electrónico</span>
            </div>
            
            <div class="modal-body">
                <p class="modal-text">
                    <strong>Folio de Venta:</strong> <span id="modal-folio"></span>
                </p>
                <p class="modal-text">
                    <strong>Cliente:</strong> <span id="modal-cliente"></span>
                </p>
                <p class="modal-text">
                    <strong>Total:</strong> <span id="modal-total"></span>
                </p>
                
                <div class="modal-input-group">
                    <label class="modal-label" for="email-input">
                        <i class="fas fa-at"></i> Correo Electrónico de Destino:
                    </label>
                    <input type="email" id="email-input" class="modal-input" 
                           placeholder="ejemplo@correo.com" autocomplete="email">
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="cerrarModalEmail()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="modal-btn" onclick="confirmarEnvioEmail()">
                    <i class="fas fa-paper-plane"></i> Enviar
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        console.log('[DEBUG] Iniciando carga de sales.js...');
    </script>
    <script src="sales.js"></script>
    <script>
        console.log('[DEBUG] sales.js cargado');
        
        // Verificar si las funciones globales existen
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[DEBUG] DOM loaded');
            console.log('[DEBUG] agregarProducto existe:', typeof agregarProducto);
            console.log('[DEBUG] finalizarVenta existe:', typeof finalizarVenta);
            console.log('[DEBUG] ventasManager existe:', typeof ventasManager);
            console.log('[DEBUG] VentasManager existe:', typeof VentasManager);
        });
    </script>
    <script>
        // Función para abrir el modal de correo
        function abrirModalCorreo() {
            // Verificar si hay una venta finalizada
            const folioInput = document.getElementById('folio');
            const postVentaSection = document.getElementById('post-venta-section');
            
            // Solo permitir envío si la sección post-venta está visible (venta finalizada)
            if (!postVentaSection || postVentaSection.style.display === 'none') {
                alert('Error: Debe finalizar una venta antes de poder enviarla por correo.\n\n1. Agregue productos\n2. Haga clic en "Finalizar Venta"\n3. Luego podrá enviar por correo');
                return;
            }
            
            // Verificar que hay un folio
            if (!folioInput || !folioInput.value) {
                alert('Error: No se encontró el folio de la venta. Debe finalizar una venta primero.');
                return;
            }
            
            // Mostrar modal directamente
            const modal = document.getElementById('emailModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('show');
                
                // Llenar datos de la venta (obtener datos reales si están disponibles)
                llenarDatosVenta();
                
                // Enfocar campo de email
                const emailInput = document.getElementById('email-input');
                if (emailInput) {
                    emailInput.value = ''; // Limpiar campo
                    setTimeout(() => emailInput.focus(), 100);
                }
            } else {
                alert('Error: No se pudo abrir el modal de correo');
            }
        }
        
        function llenarDatosVenta() {
            const folioSpan = document.getElementById('modal-folio');
            const clienteSpan = document.getElementById('modal-cliente');
            const totalSpan = document.getElementById('modal-total');
            
            // Intentar obtener datos reales de la página
            let folio = 'V-' + Date.now();
            let cliente = 'Cliente de Prueba';
            let total = '$23,423.00';
            
            // Obtener folio real del campo si existe
            const folioInput = document.getElementById('folio');
            if (folioInput && folioInput.value) {
                folio = folioInput.value;
            }
            
            // Obtener cliente real del campo si existe
            const clienteInput = document.getElementById('cliente');
            if (clienteInput && clienteInput.value) {
                cliente = clienteInput.value;
            }
            
            // Obtener total real si existe
            const totalVentaElement = document.getElementById('total-venta');
            if (totalVentaElement && totalVentaElement.textContent) {
                total = totalVentaElement.textContent;
            }
            
            // Llenar los campos del modal
            if (folioSpan) folioSpan.textContent = folio;
            if (clienteSpan) clienteSpan.textContent = cliente;
            if (totalSpan) totalSpan.textContent = total;
        }
        
        // Funciones del modal de emergencia
        function cerrarModalEmail() {
            const modal = document.getElementById('emailModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
            }
        }
        
        function confirmarEnvioEmail() {
            const emailInput = document.getElementById('email-input');
            const email = emailInput ? emailInput.value.trim() : '';
            
            if (!email) {
                alert('Por favor ingrese un correo electrónico');
                return;
            }
            
            // Validación básica de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('El formato del correo electrónico no es válido');
                return;
            }
            
            // Mostrar indicador de carga
            mostrarCargandoEmail();
            
            // Enviar correo real usando PyWebView API
            enviarCorreoReal(email);
        }
        
        async function enviarCorreoReal(email) {
            try {
                // Intentar usar la API de PyWebView para envío real
                if (window.pywebview && window.pywebview.api && window.pywebview.api.sales_enviar_correo) {
                    console.log('[EMAIL] Enviando correo real a:', email);
                    
                    const resultado = await window.pywebview.api.sales_enviar_correo(email);
                    
                    // Ocultar indicador de carga
                    ocultarCargandoEmail();
                    
                    if (resultado && resultado.status === 'success') {
                        // Mostrar mensaje de éxito
                        mostrarExitoEmail(email, 'real');
                        
                        // Cerrar modal después de 3 segundos
                        setTimeout(() => {
                            cerrarModalEmail();
                        }, 3000);
                    } else {
                        // Si es el error específico de "no hay venta", mostrar opción de demo
                        if (resultado?.message && resultado.message.includes('No hay venta finalizada')) {
                            mostrarOpcionDemo(email, resultado.message);
                        } else {
                            mostrarErrorEmail(resultado?.message || 'Error desconocido al enviar correo');
                        }
                    }
                } else {
                    console.log('[EMAIL] API no disponible, usando modo demostración');
                    // Fallback a simulación
                    setTimeout(() => {
                        ocultarCargandoEmail();
                        mostrarExitoEmail(email, 'demo');
                        setTimeout(() => cerrarModalEmail(), 2000);
                    }, 2000);
                }
            } catch (error) {
                console.error('[EMAIL] Error enviando correo:', error);
                ocultarCargandoEmail();
                mostrarErrorEmail(`Error de comunicación: ${error.message}`);
            }
        }
        
        function mostrarOpcionDemo(email, mensajeError) {
            // Cambiar el contenido del modal para ofrecer modo demo
            const modalHeader = document.querySelector('.modal-header span');
            const modalBody = document.querySelector('.modal-body');
            const modalActions = document.querySelector('.modal-actions');
            
            if (modalHeader) {
                modalHeader.innerHTML = '<i class="fas fa-info-circle" style="color: #f39c12; margin-right: 0.5rem;"></i>No hay Venta Finalizada';
            }
            
            if (modalBody) {
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 3rem; color: #f39c12; margin-bottom: 1rem;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <p style="font-size: 1rem; color: var(--text-color); margin-bottom: 1rem;">
                            <strong>${mensajeError}</strong>
                        </p>
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                            <p style="font-size: 0.9rem; color: #856404; margin-bottom: 0.5rem;">
                                <strong>Para enviar una venta real:</strong>
                            </p>
                            <ol style="text-align: left; font-size: 0.85rem; color: #856404; margin: 0;">
                                <li>Agregue productos a la venta</li>
                                <li>Haga clic en "Finalizar Venta"</li>
                                <li>Luego use "Enviar por Correo"</li>
                            </ol>
                        </div>
                        <p style="font-size: 0.9rem; color: #7f8c8d;">
                            ¿Desea probar el envío en modo demostración?
                        </p>
                    </div>
                `;
            }
            
            if (modalActions) {
                modalActions.innerHTML = `
                    <button class="modal-btn cancel" onclick="cerrarModalEmail()" style="margin-right: 0.5rem;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="modal-btn" onclick="enviarModoDemo('${email}')">
                        <i class="fas fa-vial"></i> Enviar Demo
                    </button>
                `;
                modalActions.style.display = 'flex';
                modalActions.style.justifyContent = 'center';
            }
        }
        
        function enviarModoDemo(email) {
            // Mostrar indicador de carga
            mostrarCargandoEmail();
            
            // Simular envío de correo
            setTimeout(() => {
                ocultarCargandoEmail();
                mostrarExitoEmail(email, 'demo');
                setTimeout(() => cerrarModalEmail(), 2500);
            }, 1500);
        }
        
        function mostrarCargandoEmail() {
            // Deshabilitar botones
            const enviarBtn = document.querySelector('.modal-btn:not(.cancel)');
            const cancelarBtn = document.querySelector('.modal-btn.cancel');
            
            if (enviarBtn) {
                enviarBtn.disabled = true;
                enviarBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
                enviarBtn.style.opacity = '0.7';
            }
            
            if (cancelarBtn) {
                cancelarBtn.disabled = true;
                cancelarBtn.style.opacity = '0.5';
            }
            
            // Deshabilitar campo de email
            const emailInput = document.getElementById('email-input');
            if (emailInput) {
                emailInput.disabled = true;
            }
        }
        
        function ocultarCargandoEmail() {
            // Restaurar botón de enviar
            const enviarBtn = document.querySelector('.modal-btn:not(.cancel)');
            const cancelarBtn = document.querySelector('.modal-btn.cancel');
            
            if (enviarBtn) {
                enviarBtn.disabled = false;
                enviarBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar';
                enviarBtn.style.opacity = '1';
            }
            
            if (cancelarBtn) {
                cancelarBtn.disabled = false;
                cancelarBtn.style.opacity = '1';
            }
            
            // Habilitar campo de email
            const emailInput = document.getElementById('email-input');
            if (emailInput) {
                emailInput.disabled = false;
            }
        }
        
        function mostrarExitoEmail(email, modo = 'real') {
            // Cambiar el contenido del modal a mensaje de éxito
            const modalHeader = document.querySelector('.modal-header span');
            const modalBody = document.querySelector('.modal-body');
            const modalActions = document.querySelector('.modal-actions');
            
            const esModoReal = modo === 'real';
            const iconoAdicional = esModoReal ? '<i class="fas fa-file-pdf" style="color: #e74c3c; margin-left: 0.5rem;"></i>' : '';
            
            if (modalHeader) {
                modalHeader.innerHTML = `<i class="fas fa-check-circle" style="color: #27ae60; margin-right: 0.5rem;"></i>¡Correo Enviado Exitosamente!${iconoAdicional}`;
            }
            
            if (modalBody) {
                const mensajeAdicional = esModoReal 
                    ? '<div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 0.8rem; margin-top: 1rem;"><p style="font-size: 0.85rem; color: #155724; margin: 0;"><i class="fas fa-paper-plane" style="margin-right: 0.5rem;"></i><strong>Correo Real Enviado:</strong> La nota de venta ha sido enviada exitosamente con el PDF adjunto.</p></div>'
                    : '<div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 0.8rem; margin-top: 1rem;"><p style="font-size: 0.85rem; color: #856404; margin: 0;"><i class="fas fa-vial" style="margin-right: 0.5rem;"></i><strong>Modo Demostración:</strong> Este es un envío de prueba. Para envíos reales, complete una venta primero.</p></div>';
                
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 4rem; color: #27ae60; margin-bottom: 1rem;" class="success-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <p style="font-size: 1.1rem; color: var(--text-color); margin-bottom: 0.5rem;">
                            <strong>¡Correo enviado exitosamente!</strong>
                        </p>
                        <p style="font-size: 1rem; color: #7f8c8d;">
                            El correo ha sido enviado a <strong style="color: var(--primary-color);">${email}</strong>
                        </p>
                        ${mensajeAdicional}
                        <p style="font-size: 0.9rem; color: #7f8c8d; margin-top: 1rem;">
                            Este modal se cerrará automáticamente...
                        </p>
                    </div>
                `;
            }
            
            if (modalActions) {
                modalActions.style.display = 'none';
            }
        }
        
        function mostrarErrorEmail(mensaje) {
            // Cambiar el contenido del modal a mensaje de error
            const modalHeader = document.querySelector('.modal-header span');
            const modalBody = document.querySelector('.modal-body');
            const modalActions = document.querySelector('.modal-actions');
            
            if (modalHeader) {
                modalHeader.innerHTML = '<i class="fas fa-exclamation-circle" style="color: #e74c3c; margin-right: 0.5rem;"></i>Error al Enviar Correo';
            }
            
            if (modalBody) {
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 4rem; color: #e74c3c; margin-bottom: 1rem;">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <p style="font-size: 1.1rem; color: var(--text-color); margin-bottom: 1rem;">
                            <strong>No se pudo enviar el correo:</strong>
                        </p>
                        <p style="font-size: 1rem; color: #e74c3c; background: #fdeaea; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            ${mensaje}
                        </p>
                        <p style="font-size: 0.9rem; color: #7f8c8d; margin-top: 1rem;">
                            Verifique su configuración de correo y vuelva a intentar
                        </p>
                    </div>
                `;
            }
            
            if (modalActions) {
                // Mostrar solo botón de cerrar
                modalActions.innerHTML = `
                    <button class="modal-btn cancel" onclick="cerrarModalEmail()" style="margin: 0 auto;">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                `;
                modalActions.style.display = 'flex';
                modalActions.style.justifyContent = 'center';
            }
        }
        
        // Función de prueba para verificar PyWebView
        async function testPyWebView() {
            alert('Iniciando prueba de PyWebView...');
            
            try {
                if (window.pywebview && window.pywebview.api) {
                    alert('PyWebView detectado. Llamando a test_connection...');
                    
                    if (window.pywebview.api.test_connection) {
                        const resultado = await window.pywebview.api.test_connection();
                        alert(`Resultado: ${JSON.stringify(resultado)}`);
                    } else {
                        alert('ERROR: Función test_connection no encontrada');
                    }
                } else {
                    alert('ERROR: PyWebView no está disponible');
                }
            } catch (error) {
                alert(`ERROR: ${error.message}`);
            }
        }
        
        // Función de prueba simple
        function testSimple() {
            alert('Función testSimple ejecutada correctamente!');
            console.log('TEST: Función simple funcionando');
            
            // Verificar si existe ventasManager
            if (typeof ventasManager !== 'undefined') {
                alert('ventasManager existe!');
                console.log('TEST: ventasManager encontrado:', ventasManager);
            } else {
                alert('ERROR: ventasManager no existe!');
                console.log('TEST: ventasManager no encontrado');
            }
            
            // Verificar si existe VentasManager
            if (typeof VentasManager !== 'undefined') {
                alert('VentasManager clase existe!');
                console.log('TEST: VentasManager clase encontrada');
            } else {
                alert('ERROR: VentasManager clase no existe!');
                console.log('TEST: VentasManager clase no encontrada');
            }
        }
        
        // Función de prueba directa a Python
        async function testDirectPython() {
            alert('Probando llamada directa a Python...');
            
            try {
                if (window.pywebview && window.pywebview.api && window.pywebview.api.sales_agregar_producto) {
                    console.log('[TEST] Llamando directamente a sales_agregar_producto...');
                    const resultado1 = await window.pywebview.api.sales_agregar_producto('Producto Test Directo', '100.00');
                    console.log('[TEST] Resultado agregar:', resultado1);
                    
                    // Ahora finalizar para guardar en BD
                    console.log('[TEST] Llamando directamente a sales_finalizar_venta...');
                    const resultado2 = await window.pywebview.api.sales_finalizar_venta('Cliente Test Directo');
                    console.log('[TEST] Resultado finalizar:', resultado2);
                    
                    alert(`Agregado: ${JSON.stringify(resultado1)}\n\nFinalizado: ${JSON.stringify(resultado2)}`);
                } else {
                    alert('ERROR: API sales_agregar_producto no disponible');
                }
            } catch (error) {
                alert(`ERROR: ${error.message}`);
            }
        }
    </script>
    <script src="../js/sidebar-new.js"></script>
</body>
</html>