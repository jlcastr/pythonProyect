<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìã Notas de Venta - S&M</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.2rem;
        }
        
        .loading-content {
            text-align: center;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
        }
        
        .loading-spinner {
            font-size: 2rem;
            margin-bottom: 1rem;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            border-left: 4px solid #dc3545;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            border-left: 4px solid #28a745;
        }
        
        .info-message {
            background: #d1ecf1;
            color: #0c5460;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            border-left: 4px solid #17a2b8;
        }

        /* Estilos espec√≠ficos para el dise√±o de dos columnas */
        .dual-column-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            height: 600px;
        }

        .column-section {
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        .column-title {
            color: var(--primary-color);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 0.5rem;
        }

        .table-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .notes-table {
            width: 100%;
            border-collapse: collapse;
            flex: 1;
            overflow-y: auto;
            display: block;
            height: 100%;
        }

        .notes-table thead {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .notes-table tbody {
            display: block;
            height: calc(100% - 40px);
            overflow-y: auto;
            width: 100%;
        }

        .notes-table tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .notes-table th,
        .notes-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .notes-table th {
            background: linear-gradient(145deg, var(--primary-color), var(--hover-color));
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .notes-table tbody tr:nth-child(even) {
            background-color: var(--background-color);
        }

        .notes-table tbody tr:hover {
            background: linear-gradient(145deg, #ffffff 0%, #e8f4fd 100%);
            cursor: pointer;
        }

        .notes-table tbody tr.selected {
            background: linear-gradient(145deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid var(--primary-color);
        }

        /* Columnas espec√≠ficas para cada tabla */
        .ventas-table th:nth-child(1) { width: 15%; } /* Folio */
        .ventas-table th:nth-child(2) { width: 40%; } /* Cliente */
        .ventas-table th:nth-child(3) { width: 25%; } /* Fecha */
        .ventas-table th:nth-child(4) { width: 20%; } /* Total */

        .items-table th:nth-child(1) { width: 70%; } /* Descripci√≥n */
        .items-table th:nth-child(2) { width: 30%; } /* Precio */

        .empty-state-small {
            text-align: center;
            padding: 2rem 1rem;
            color: #7f8c8d;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .empty-state-small i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dual-column-container {
                grid-template-columns: 1fr;
                height: auto;
                gap: 1rem;
            }

            .column-section {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .notes-table th,
            .notes-table td {
                padding: 0.25rem;
                font-size: 0.85rem;
            }

            .column-title {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header" style="padding: 0.75rem 1rem; min-height: auto;">
            <div class="header-content" style="padding: 0;">
                <div class="logo-section" style="align-items: center; gap: 1rem;">
                    <div class="logo-circle" style="width: 50px; height: 50px; font-size: 0.85rem;">
                        <span class="logo-text" style="font-size: 0.9rem; font-weight: bold;">S&M</span>
                        <div class="logo-subtitle" style="font-size: 0.6rem; margin-top: 2px;">NOTAS</div>
                    </div>
                    <div class="title-section">
                        <h1 class="main-title" style="font-size: 1.25rem; margin: 0; line-height: 1.2;">Notas de Venta</h1>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="sales-container">
                
                <!-- Date Filters Section -->
                <div class="sales-section">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 200px; gap: 1rem; align-items: end; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label" for="fecha-inicio">Fecha Inicio:</label>
                            <input type="date" id="fecha-inicio" class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="fecha-fin">Fecha Fin:</label>
                            <input type="date" id="fecha-fin" class="form-input">
                        </div>
                        
                        <button class="btn-sales" onclick="filtrarVentas()">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                    </div>
                </div>

                <!-- Dual Column Data Section -->
                <div class="sales-section">
                    <div class="dual-column-container">
                        
                        <!-- Left Column - Ventas Master -->
                        <div class="column-section">
                            <div class="column-title">
                                <i class="fas fa-receipt"></i>
                                Ventas Realizadas
                                <span id="contador-ventas" style="margin-left: auto; background: var(--secondary-color); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem;">0</span>
                            </div>
                            
                            <div class="table-container">
                                <div id="ventas-container">
                                    <div class="empty-state-small">
                                        <i class="fas fa-receipt"></i>
                                        <p>No hay ventas registradas</p>
                                        <p style="font-size: 0.85rem;">Use los filtros para buscar ventas espec√≠ficas</p>
                                    </div>
                                </div>
                                
                                <table id="ventas-tabla" class="notes-table ventas-table" style="display: none;">
                                    <thead>
                                        <tr>
                                            <th>Folio</th>
                                            <th>Cliente</th>
                                            <th>Fecha</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ventas-tbody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Right Column - Items de Venta -->
                        <div class="column-section">
                            <div class="column-title">
                                <i class="fas fa-shopping-basket"></i>
                                Items de la Venta Seleccionada
                                <span id="contador-items" style="margin-left: auto; background: var(--secondary-color); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem;">0</span>
                            </div>
                            
                            <div class="table-container">
                                <div id="items-container">
                                    <div class="empty-state-small">
                                        <i class="fas fa-shopping-basket"></i>
                                        <p>Seleccione una venta</p>
                                        <p style="font-size: 0.85rem;">Haga clic en una venta para ver sus items</p>
                                    </div>
                                </div>
                                
                                <table id="items-tabla" class="notes-table items-table" style="display: none;">
                                    <thead>
                                        <tr>
                                            <th>Descripci√≥n del Producto</th>
                                            <th>Precio</th>
                                        </tr>
                                    </thead>
                                    <tbody id="items-tbody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Total Section -->
                <div class="sales-section" id="total-section">
                    <div class="total-section">
                        <div id="total-label">Total General</div>
                        <div class="total-amount" id="total-venta">$0.00</div>
                    </div>
                </div>

            </div>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <p>&copy; 2025 Sistema de Ventas S&M - M√≥dulo de Notas de Venta</p>
        </footer>
        
        <!-- Error/Success Messages -->
        <div id="message-container"></div>
    </div>

    <!-- Scripts -->
    <script>
        // Variables globales
        let ventasData = [];
        let filteredVentas = [];
        let selectedVenta = null;

        // Configuraci√≥n de fechas por defecto
        function configurarFechasPorDefecto() {
            const hoy = new Date();
            const fechaHoyStr = hoy.toISOString().split('T')[0];
            
            const fechaInicio = document.getElementById('fecha-inicio');
            const fechaFin = document.getElementById('fecha-fin');
            
            fechaInicio.value = fechaHoyStr;
            fechaFin.value = fechaHoyStr;
        }

        // Mostrar indicador de carga
        function mostrarCargando(mensaje = 'Cargando datos...') {
            const overlay = document.createElement('div');
            overlay.id = 'loading-overlay';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="loading-content">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner"></i>
                    </div>
                    <div>${mensaje}</div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        // Ocultar indicador de carga
        function ocultarCargando() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Mostrar mensaje
        function mostrarMensaje(mensaje, tipo = 'error') {
            const container = document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            
            let className = 'error-message';
            let icon = 'exclamation-triangle';
            
            if (tipo === 'success') {
                className = 'success-message';
                icon = 'check-circle';
            } else if (tipo === 'info') {
                className = 'info-message';
                icon = 'info-circle';
            }
            
            messageDiv.className = className;
            messageDiv.innerHTML = `
                <i class="fas fa-${icon}"></i>
                ${mensaje}
            `;
            container.appendChild(messageDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Cargar datos de ventas maestras
        async function cargarDatosVentas(fechaInicio = '', fechaFin = '') {
            try {
                mostrarCargando('Cargando notas de venta...');
                console.log('[API] Intentando cargar ventas con fechas:', fechaInicio, fechaFin);
                
                // Verificar si PyWebView est√° disponible
                if (window.pywebview && window.pywebview.api) {
                    console.log('[API] PyWebView disponible, verificando funci√≥n get_sales_master...');
                    
                    if (window.pywebview.api.get_sales_master) {
                        console.log('[API] Llamando a get_sales_master...');
                        const resultado = await window.pywebview.api.get_sales_master(fechaInicio, fechaFin);
                        
                        if (resultado && resultado.status === 'success') {
                            ventasData = resultado.data || [];
                            console.log('[API] Datos de ventas maestras cargados:', ventasData.length, 'registros');
                            mostrarMensaje(`‚úÖ ${ventasData.length} ventas cargadas exitosamente.`, 'success');
                        } else {
                            console.log('[API] No se pudieron cargar las ventas:', resultado?.message);
                            ventasData = [];
                            mostrarMensaje(resultado?.message || '‚ùå No se pudieron cargar las notas de venta.', 'error');
                        }
                    } else {
                        console.log('[API] Funci√≥n get_sales_master no encontrada');
                        ventasData = [];
                        mostrarMensaje('‚ùå La funci√≥n de carga de ventas no est√° disponible.', 'error');
                    }
                } else {
                    console.log('[API] PyWebView no disponible');
                    ventasData = [];
                    mostrarMensaje('‚ùå Error: No se pudo conectar con la base de datos. Aseg√∫rese de ejecutar la aplicaci√≥n desde el launcher de Python.', 'error');
                }
                
                filteredVentas = [...ventasData];
                actualizarTablaVentas();
                calcularTotalGeneral();
                limpiarSeleccionVenta();
                
            } catch (error) {
                console.error('[API] Error cargando ventas:', error);
                mostrarMensaje('‚ùå Error al cargar las notas de venta desde la base de datos.');
                
                ventasData = [];
                filteredVentas = [];
                actualizarTablaVentas();
                calcularTotalGeneral();
            } finally {
                ocultarCargando();
            }
        }

        // Cargar items de una venta espec√≠fica
        async function cargarItemsVenta(ventaId) {
            try {
                console.log('[API] Cargando items para venta ID:', ventaId);
                
                if (window.pywebview && window.pywebview.api && window.pywebview.api.get_sales_items) {
                    const resultado = await window.pywebview.api.get_sales_items(ventaId);
                    
                    if (resultado && resultado.status === 'success') {
                        const items = resultado.data || [];
                        console.log('[API] Items cargados:', items.length, 'registros');
                        actualizarTablaItems(items);
                        return items;
                    } else {
                        console.log('[API] No se pudieron cargar los items:', resultado?.message);
                        actualizarTablaItems([]);
                        return [];
                    }
                } else {
                    console.log('[API] Funci√≥n get_sales_items no disponible');
                    actualizarTablaItems([]);
                    return [];
                }
                
            } catch (error) {
                console.error('[API] Error cargando items:', error);
                actualizarTablaItems([]);
                return [];
            }
        }

        // Filtrar ventas por fecha
        async function filtrarVentas() {
            const fechaInicio = document.getElementById('fecha-inicio').value;
            const fechaFin = document.getElementById('fecha-fin').value;
            
            console.log('[FILTER] Aplicando filtro - Inicio:', fechaInicio, 'Fin:', fechaFin);
            
            // Validar fechas
            if (fechaInicio && fechaFin && new Date(fechaInicio) > new Date(fechaFin)) {
                mostrarMensaje('‚ùå La fecha de inicio no puede ser mayor que la fecha de fin.');
                return;
            }
            
            // Cargar datos con filtro desde la base de datos
            await cargarDatosVentas(fechaInicio, fechaFin);
        }

        // Actualizar tabla de ventas maestras
        function actualizarTablaVentas() {
            const tbody = document.getElementById('ventas-tbody');
            const emptyState = document.querySelector('#ventas-container .empty-state-small');
            const table = document.getElementById('ventas-tabla');
            const contador = document.getElementById('contador-ventas');
            
            // Limpiar tabla
            tbody.innerHTML = '';
            
            // Actualizar contador
            contador.textContent = filteredVentas.length;
            
            if (filteredVentas.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'flex';
                return;
            }
            
            table.style.display = 'table';
            emptyState.style.display = 'none';
            
            // Llenar tabla
            filteredVentas.forEach((venta, index) => {
                const row = document.createElement('tr');
                row.dataset.ventaId = venta.id;
                row.dataset.index = index;
                
                row.innerHTML = `
                    <td>${venta.folio}</td>
                    <td>${venta.cliente}</td>
                    <td>${formatearFecha(venta.fecha_venta)}</td>
                    <td>$${parseFloat(venta.total || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}</td>
                `;
                
                // Event listener para seleccionar venta
                row.addEventListener('click', () => {
                    seleccionarVenta(venta, row);
                });
                
                tbody.appendChild(row);
            });
        }

        // Actualizar tabla de items
        function actualizarTablaItems(items) {
            const tbody = document.getElementById('items-tbody');
            const emptyState = document.querySelector('#items-container .empty-state-small');
            const table = document.getElementById('items-tabla');
            const contador = document.getElementById('contador-items');
            
            // Limpiar tabla
            tbody.innerHTML = '';
            
            // Actualizar contador
            contador.textContent = items.length;
            
            if (items.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'flex';
                return;
            }
            
            table.style.display = 'table';
            emptyState.style.display = 'none';
            
            // Llenar tabla
            items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.descripcion}</td>
                    <td>$${parseFloat(item.precio).toLocaleString('es-MX', {minimumFractionDigits: 2})}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Seleccionar una venta
        async function seleccionarVenta(venta, row) {
            // Limpiar selecci√≥n anterior
            document.querySelectorAll('#ventas-tbody tr').forEach(tr => {
                tr.classList.remove('selected');
            });
            
            // Marcar como seleccionada
            row.classList.add('selected');
            selectedVenta = venta;
            
            // Actualizar total para mostrar solo esta venta
            const totalLabel = document.getElementById('total-label');
            const totalVenta = document.getElementById('total-venta');
            totalLabel.textContent = 'Total de Venta Seleccionada';
            totalVenta.textContent = `$${parseFloat(venta.total || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}`;
            
            // Cargar items de la venta
            await cargarItemsVenta(venta.id);
        }

        // Limpiar selecci√≥n de venta
        function limpiarSeleccionVenta() {
            document.querySelectorAll('#ventas-tbody tr').forEach(tr => {
                tr.classList.remove('selected');
            });
            
            selectedVenta = null;
            actualizarTablaItems([]);
            
            // Volver al total general
            const totalLabel = document.getElementById('total-label');
            totalLabel.textContent = 'Total General';
            calcularTotalGeneral();
        }

        // Calcular y mostrar total general
        function calcularTotalGeneral() {
            const total = filteredVentas.reduce((sum, venta) => sum + parseFloat(venta.total || 0), 0);
            const totalElement = document.getElementById('total-venta');
            if (totalElement) {
                totalElement.textContent = `$${total.toLocaleString('es-MX', {minimumFractionDigits: 2})}`;
            }
        }

        // Formatear fecha para mostrar
        function formatearFecha(fechaStr) {
            try {
                const fechaISO = fechaStr.replace(' ', 'T');
                const fecha = new Date(fechaISO);
                
                if (isNaN(fecha.getTime())) {
                    console.warn('[DATE] Fecha inv√°lida:', fechaStr);
                    return fechaStr;
                }
                
                return fecha.toLocaleDateString('es-MX', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }) + ' ' + fecha.toLocaleTimeString('es-MX', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                console.error('[DATE] Error formateando fecha:', fechaStr, error);
                return fechaStr;
            }
        }

        // Volver al men√∫ de reportes
        function volverAlMenuReportes() {
            console.log('[NAV] Volviendo al men√∫ de reportes...');
            try {
                if (window.pywebview && window.pywebview.api && window.pywebview.api.volver_menu_reportes) {
                    console.log('[NAV] Usando API de PyWebView para navegar');
                    window.pywebview.api.volver_menu_reportes();
                } else {
                    console.log('[NAV] Navegaci√≥n HTML directa');
                    window.location.href = 'menu_report.html';
                }
            } catch (error) {
                console.error('[NAV] Error volviendo al men√∫ de reportes:', error);
                window.location.href = 'menu_report.html';
            }
        }

        // Funci√≥n para esperar a que PyWebView est√© listo
        function esperarPyWebView(callback, intentos = 0) {
            const maxIntentos = 20;
            
            if (window.pywebview && window.pywebview.api) {
                console.log('[DEBUG] PyWebView listo despu√©s de', intentos, 'intentos');
                callback();
            } else if (intentos < maxIntentos) {
                console.log('[DEBUG] Esperando PyWebView... intento', intentos + 1);
                setTimeout(() => esperarPyWebView(callback, intentos + 1), 500);
            } else {
                console.log('[DEBUG] PyWebView no disponible despu√©s de', maxIntentos, 'intentos');
                callback();
            }
        }

        // Event listener para clic en √°rea vac√≠a de la tabla de ventas
        document.addEventListener('click', function(event) {
            const ventasTable = document.getElementById('ventas-tabla');
            if (ventasTable && ventasTable.contains(event.target)) {
                // Si se hace clic en el √°rea vac√≠a de la tabla, limpiar selecci√≥n
                const clickedRow = event.target.closest('tr');
                if (!clickedRow || !clickedRow.dataset.ventaId) {
                    limpiarSeleccionVenta();
                }
            }
        });

        // Inicializaci√≥n al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìã Notas de Venta - Inicializando...');
            
            configurarFechasPorDefecto();
            
            // Esperar a que PyWebView est√© listo antes de cargar datos
            esperarPyWebView(function() {
                console.log('[DEBUG] Verificando disponibilidad de PyWebView...');
                
                if (window.pywebview) {
                    console.log('[DEBUG] PyWebView detectado');
                } else {
                    console.log('[DEBUG] PyWebView NO detectado');
                }
                
                cargarDatosVentas();
            });
        });

        // Limpiar mensajes al hacer clic
        document.getElementById('message-container').addEventListener('click', function(e) {
            if (e.target.closest('.error-message') || e.target.closest('.success-message') || e.target.closest('.info-message')) {
                e.target.closest('.error-message, .success-message, .info-message').remove();
            }
        });
    </script>
    
    <script src="../js/sidebar-new.js"></script>
</body>
</html>
